# 3D 街中ラン 企画書

## 1. 概要

3D空間の街中を飛行し、アイテムを取得しながら生存時間を伸ばし、定期的に出現する敵・ライバルと対戦するゲーム。  
**マスク**は複数所持でき、敵を倒すとドロップし回収して能力を吸収できる。同種のマスクは合成され効果が上がる。多く持つほど有利だが、大きなダメージを受けるとマスクを落とす。敵もプレイヤーや雑魚を倒してマスクを奪い強くなる。  
エネルギー消費の加速・減速、回復クールダウン、成長ボーナス、装備・磁石・ストレージなどのパラメータ拡張を予定。敗北時は輪廻転生して再挑戦する。

---

## 2. 現在の実装状況

### 2.1 プレイヤー（ランタイム状態）

| パラメータ | 説明 |
|-----------|------|
| エネルギー | 0〜100。食べ物取得で即回復、W/S で消費。 |
| 向き（yaw） | カメラの水平向き。 |
| 速度倍率 | 通常 1 / 加速 1.6 / 減速 0.5。 |
| 回復クールダウン | 加速・減速直後の回復待ち（秒）。 |

### 2.2 定数（速度・エネルギー・高度）

- 通常速度・旋回速度・上下速度・エネルギー消費/回復・最低/最高高度・キー入力状態

### 2.3 アイテム・取得

- 食べ物: 1種類のみ。取得でエネルギー即回復。取得半径は固定。
- 未実装: 食べ物の種類・バフ・キュー、装備、ストレージ、磁石。食べ物の出現は**固定配置＋時間でスポーン**を想定。

### 2.4 UI

- 実装済み: エネルギーゲージ、POS/ALT/SPEED、方向メーター
- 未実装: 所持一覧、バフゲージ、敵体力ゲージ、ステータス数値表示

---

## 3. 拡張予定：プレイヤーパラメータ

### 3.1 攻撃・防御（用語統一）

| 種別 | パラメータ | 説明 |
|------|------------|------|
| 攻撃 | 攻撃力 | 与ダメージの基礎値または倍率。 |
| 攻撃 | 攻撃クールダウン | 次の攻撃までのクールダウン（秒）。 |
| 攻撃 | 攻撃到達距離 | 攻撃の有効距離。 |
| 防御 | 防御クールダウン | 防御行動後のクールダウン（秒）。 |
| 防御 | 防御力 | 受けるダメージの軽減率または固定減算。 |
| 防御 | 回避力（運） | 被弾回避確率・クリティカル等の運要素。 |

装備・宝石・一時バフで増減させる想定。**攻撃**は**敵との距離で自動発動**（クールタイム・索敵範囲などパラメータ依存）。**装備で飛び道具／近接が決まり**、敵との距離で近接か遠距離かは**自動で切り替わる**。近接と飛び道具は併用可能で、**近接の方が攻撃は強め**。**防御**はボタン発動ではなく、**被弾時に自動で判定**（防御力・回避力で軽減のみ）。

### 3.2 取得・移動まわり

| パラメータ | 説明 |
|-----------|------|
| 有効取得範囲 | ベース取得半径に磁石等で加算/乗算。 |
| 吸引率 | 範囲内アイテムをプレイヤー方向に引き寄せる強さ（0＝なし）。 |
| 旋回制御（グリップ） | 旋回の効き。高い＝キリッと曲がる。低い＝ドリフト（スリップ）して流れる。 |
| **能力吸収力** | マスク回収時に、敵の能力の何割を自分の能力として吸収できるか。高いほど吸収量が増える。 |
| **索敵** | 敵を検知できる範囲・精度。高いと遠距離でも敵の位置がわかる。敵位置ガイドの表示距離や精度に反映。アイテム・マスクで強化。 |
| **持続延長** | 一時バフの効果時間の倍率。高いほどバフの持続時間が長くなる。装備・マスクなどで強化。 |

### 3.3 生存時間・年齢

- プレイ開始からの経過時間（秒）またはゲーム内「年齢」。
- ランキング・達成感・「長く生きている＝強い」演出に利用。
- 5分ごとの成長選択・15分ごとのライバル出現のトリガーに使用。

---

## 4. 拡張予定：アイテム・装備・ストレージ

### 4.1 一時効果（食べ物・薬など）

- **種類**は**6種類以上**を想定（速度Up、回復クールダウン短縮など）。
- **持続時間**は**種類ごとに固定秒数**。**持続延長**（一時バフの効果時間の倍率）も成長パラメータの要素として持つ（装備・マスクなどで延長可能）。
- 食べ物・薬は**所持枠とは別枠**（消費キュー専用でキューで保持）。取得はキューに追加し、**とった順に1つずつ消費**。消費中は種類ごとのゲージが減り、0で効果終了・消滅。
- 現在有効なバフから、速度倍率・回復クールダウンなどを計算。

### 4.2 永続効果（宝石・装備） ✅ 実装済み

詳細は別資料を参照: **[docs/equipment-spec.md](docs/equipment-spec.md)**

- **装備スロット**: 初期5枠、宝石と装備で共有
- **バッグ**装備でスロット数が増加（+2枠）
- **宝石**: 誕生石12種類からランダム、効果は宝石の種類で決定
- **装備**: 16種類（バッグ、磁石、靴、メガネ、防具、武器、時計、薬、翼、自転車、釣り具、帽子、タオル、旗、服、料理道具）
- **出現**: OpenStreetMapのお店データに基づき配置（宝石店→宝石、靴屋→靴、など）

| カテゴリ | 種類数 | 効果例 |
|---------|--------|--------|
| 宝石 | 12種 | 攻撃、防御、速度、取得範囲、吸引、索敵、バフ持続、回復CD、全能力 |
| 装備 | 16種 | スロット拡張、速度、上下速度、地上速度、磁石、索敵、攻撃、防御、食事バフ強化 |

### 4.3 ストレージ（バッグ等） ✅ 実装済み

- **所持アイテム数の初期上限**は**5個**。
- **バッグ**は**別枠**（装備スロットを消費しない）で**無制限**に取得可能。
- バッグ1つにつき装備スロットが**+2**される。
- 有効取得範囲・吸引率は磁石等の装備で増減。

### 4.4 アイテム・マスクによる強化の反映

- **攻撃・防御・取得範囲・能力吸収力・索敵・敵位置ガイド**など、各種パラメータは**アイテム取得**や**マスク回収**で強化される。
- アイテムをとったりマスクを集めることで、総合的に有利になっていく設計。

### 4.5 食べ物の種類

詳細は別資料を参照: **[docs/food-spec.md](docs/food-spec.md)**

| typeId | 名前 | 色 | 効果 | 持続 | 出現率 | 実装 |
|--------|------|----|------|------|--------|------|
| `energy` | エネルギー | 黄 | エネルギー +25 | — | 85% | ✅ |
| `speedUp` | 速度Up | 緑 | 速度 ×1.2 | 30秒 | 10% | ✅ |
| `recoveryCooldownShort` | 回復短縮 | 青 | 回復CD ×0.5 | 45秒 | 5% | ✅ |
| 取得範囲Up | — | — | 取得範囲アップ | 60秒 | — | ❌ |
| 吸引Up | — | — | 吸引率アップ | 40秒 | — | ❌ |
| 攻撃Up | — | — | 攻撃力アップ | 50秒 | — | ❌ |
| 防御Up | — | — | 防御力アップ | 50秒 | — | ❌ |
| 持続延長 | — | — | 他バフ持続延長 | 20秒 | — | ❌ |

---

## 5. 拡張予定：成長選択ダイアログ（5分ごと＋アイテム取得時）

- **トリガー**: 生存時間が **5分・10分・15分・20分…**（5分間隔）に達したら「成長選択発生フラグ」を立てる。**アイテムを取得したとき**にフラグが立っていれば**成長選択ダイアログ**を表示し、フラグをクリア。**5分と15分が重なったとき**は**先に成長選択**→その後ライバル出現。ダイアログ表示中は**ゲームをポーズ**（時間停止・敵も止まる）。
- **選択肢数**: **運が高いほど多い**。3択／4択／5択をランダム（運で4択・5択の出る確率を上げる）。
- **内容**: 各選択肢は「攻撃力・防御力・速度・グリップ・取得範囲など」のいずれか1パラメータを成長させる内容をランダムに提示。プレイヤーが1つ選ぶとそのパラメータがボーナスで上昇。
- **性質**: **成長ボーナス**のため、上昇量はかなり有利に強くなる設計。

---

## 6. 拡張予定：敵・マスク・対戦・敗北・輪廻転生

### 6.1 敵の種類と出現タイミング

| 出現間隔 | 敵の種類 | 強さ |
|----------|----------|------|
| **1分ごと** | **雑魚敵** | プレイヤーより弱い。簡単に倒せる。**複数体まで同時に存在可能**（最大**3体**）。**強さは常に一定**（生存時間で強くしない）。敵の体力は敵ごとに別スケール（**雑魚は少なめ・例：最大30**、**ライバルはプレイヤー同様・100前後**）。 |
| **15分ごと** | **ライバル** | プレイヤーと同等の総合能力で、パラメータの配分だけ少し違う。出現したら対戦状態。 |
- **敵同士**（雑魚vs雑魚、ライバルvs雑魚）も**戦闘する**。敵も互いに倒し合い、マスクを奪い合う。敵の**ターゲット**は**弱い敵を優先**（マスクを奪いやすい）。

### 6.2 敵の強さと見た目（マスク）

- **マスクは色・形・模様など多種多様**で、集めること自体が**コレクション要素**としても機能する。種類は**中程度**（10〜20種類程度）を想定。**効果**は**色・形ごとに割り当て**（例：赤＝攻撃、青＝防御など）を基本とし、**特殊なマスク**も用意する想定。
- **敵は頭部にマスクを装飾・配置**している。**マスクの色や形状で強さがわかる**（見た目で強さが判別できる）。
- **強敵**の場合は、マスクが**豪華**だったり、**複数かぶって**いて**威圧感**がある。
- **プレイヤー**の所持マスクは**UI（所持一覧・アイコン）のみ**で表示（3D上では頭部装着しない）。
- 倒すと**マスクをドロップ**する。
- **敵も同様**に、自分より弱い敵（雑魚やプレイヤー）を倒して**マスクを奪い**、**マスクで強化**される。敵はプレイヤーや雑魚を倒してマスクを集め、強くなろうとする。

**マスク種類の具体例（案）**（色・形で効果を割り当て。10〜20種類想定）

| 系統 | 効果イメージ | 備考 |
|------|--------------|------|
| 赤系 | 攻撃力・与ダメージ | 近接・飛び道具の基礎値アップ |
| 青系 | 防御力・被ダメージ軽減 | 被弾時の軽減率 |
| 緑系 | 速度・旋回・グリップ | 移動・操作性 |
| 黄系 | 取得範囲・吸引・能力吸収 | アイテム・マスク回収 |
| 紫系 | 索敵・持続延長 | 敵位置ガイド・バフ時間 |
| 特殊 | 複合・レア効果 | 1種のみなど |

- 同種マスクは**合成でLvアップ**（Lv2＝1.2倍、Lv3＝1.3倍など）。数値は調整可能。

### 6.3 マスクの所持・回収・ドロップ・合成

- **マスクは複数所持可能**。より多くのマスクを持っていることが有利になる設計。
- **マスクを回収**すると、**敵の能力の一部を自分の能力として扱える**ようになる。吸収量は**能力吸収力**パラメータで決まる（装備・バフで増減）。
- **自分のエネルギーを大きく削る攻撃**を受けたときは、**マスクを1つ落とす**（ペナルティ）。「大きなダメージ」＝**一撃でエネルギーが25％以上減ったとき**。落とすマスクは**ランダム**で選択。落としたマスクはフィールドにドロップし、他者が回収できる想定。
- **マスクの所持数上限**は**なし**（ストレージの枠とは別に、マスクは無制限に持てる想定）。
- **同じ種類のマスク**は**合成**され、**さらなる効果**が発揮される。同種を複数持つと1つにまとまり、**Lvごとに効果を加算**（例：Lv2＝1.2倍、Lv3＝1.3倍など。数値は後で調整可能）。

### 6.4 敵位置ガイド（UI・索敵）

- 敵が出現すると**画面外にいる敵にも注意が必要**になるため、**UI上に敵の位置を3D的に表示**する。
- **どの方向に・どれくらいの距離に**敵がいるかを示すガイド（例: 画面端の矢印・距離表示、ミニマップ風の方向表示など）。
- **索敵**パラメータが高いと、**遠距離の敵も検知・表示**できる（索敵が低いと近くの敵のみ、高いと遠くまで表示）。
- 索敵・敵位置ガイドの精度は**アイテムやマスクの効果**で強化される。

### 6.5 ライバル出現（15分ごと）

- **15分ごと**にプレイヤーの**ライバル**が出現。
- ライバルの強さは**プレイヤーのベース能力のみ**を基準にする（マスク・装備の効果は含めない）。パラメータの配分だけ少し違う（例: 攻撃高め・防御低めなど）。出現したら対戦状態になる。

### 6.6 敵体力ゲージ・ヒット演出

- **敵の体力ゲージ**は**敵の上部**に表示する。敵が複数いるときも各敵の頭上にゲージを出す。
- **ボス（ライバルなど）**の場合は、画面外にいても**ゲージや所持マスクを別枠で表示**する。
- 攻撃が当たったときの**エフェクト**として、**ゲージが減った部分が少しの時間光る**など、**どれだけ削ったかがわかるUI**にする。

### 6.7 敗北条件

- **エネルギーが0を下回るような攻撃**を受けると**敗北**。

### 6.8 輪廻転生

- 敗北後は**輪廻転生**する（リスポーン／再開）。リスポーン位置は**決まった初期位置**に戻る。
- **転生後**：  
  - **マスク**：敗北時に持っていたマスクのうち、**転生回数ぶんだけ**所持して再開（初回転生時は1つ、2回目は2つ、…）。  
  - **所持アイテム**（食べ物・薬・装備・宝石・ストレージなど）：**すべてリセット**（0から）。  
  - **パラメータ**（攻撃力・防御力・索敵・能力吸収力など）：**ベース値にリセット**（転生ボーナスなどは別途検討）。  
  - **生存時間（年齢）**：**0にリセット**。**転生回数**はUIに表示する。

---

## 7. 拡張予定：UI・演出

### 7.1 数値で確認できるUI

- エネルギー・攻撃力・防御力・回避力・取得範囲・生存時間／年齢・グリップ・**能力吸収力**・**索敵**などを、ステータス画面や常時表示で**数値表示**。

### 7.2 値が増えることの楽しさ（成長フィードバック）

- パラメータが増えたときに楽しさを表現する。
- 例: 強くなるとエフェクトがかかる（オーラ・光・パーティクル）、数値上昇時の短い演出やSE、数値の「+N」ポップ表示など。

### 7.3 UI 一覧（目標）

- エネルギー・POS/ALT/SPEED・方向メーター（現状のまま）
- 所持アイテム一覧、**所持マスク一覧（コレクション用）**、バッグ/ストレージの上限表示
- 一時効果: バフゲージ、取得順の消費キュー＋ゲージ
- ステータス数値の表示
- **敵位置ガイド**: 敵の**方向・距離**をUI上に**3D的に表示**（画面外の敵も把握できる）。索敵が高いと遠距離まで表示。
- **敵体力ゲージ**: 各敵の**頭上**に表示。**ボス（ライバル）**は画面外でも**ゲージ・所持マスクを別枠**で表示。攻撃ヒット時は減った部分が短時間光る演出。
- **転生回数**の表示。
- **クリア条件**は設けない（生存し続けるだけ。スコア／転生が主な目標）。

---

## 8. 実装ステップ一覧と開発フェーズ

### 8.1 開発フェーズ（優先度）

| フェーズ | 目標 | ステップ |
|----------|------|----------|
| **Phase 1：コア拡張** | プレイ・アイテム・成長の土台 | 1 → 2 → 3 → 4 → 7 → 7b |
| **Phase 2：戦闘・敵** | 雑魚敵・マスク・索敵・ガイド | 5 → 6 → 8 → 8b |
| **Phase 3：ライバル・転生** | 敗北・輪廻転生・長期プレイ | 9 → 10 |

- **Phase 1**：クールダウン定数化、食べ物種類・一時バフ、装備・所持上限、UI数値表示、生存時間、成長選択ダイアログ。ビジュアルは現状のままでもプレイ可能な範囲を拡張。
- **Phase 2**：取得範囲・吸引、攻撃・防御パラメータ、雑魚敵・マスク・能力吸収、敵位置ガイド・索敵。
- **Phase 3**：ライバル出現、敵体力・ヒット演出、敗北・輪廻転生、旋回制御（グリップ）。

### 8.2 実装ステップ一覧（候補）

1. **クールダウン時間のパラメータ化**  
   回復クールダウン時間を定数化（例: 1.0秒）。
2. **食べ物の種類と一時バフ**  
   効果タイプ・持続時間・キュー消費を導入。
3. **装備・所持アイテムと上限**  
   装備スロット・所持リスト・最大所持数・ストレージで上限増加。
4. **UI（数値表示・成長フィードバック）**  
   パラメータの数値表示、強くなるとエフェクト等の演出。
5. **取得範囲・吸引のパラメータ化（磁石用）**  
   有効取得範囲・吸引率をプレイヤー状態または装備から計算。
6. **戦闘・防御パラメータの追加**  
   攻撃力・攻撃クールダウン・攻撃到達距離・防御力・防御クールダウン・回避力。敵とのダメージループ。
7. **生存時間・年齢のパラメータ化**  
   経過時間／年齢の保持・加算・表示。
7b. **成長選択ダイアログ**  
   5分間隔でフラグ、アイテム取得時に3〜5択の成長選択（運で選択肢数が増える）。
8. **雑魚敵（1分ごと）・マスク・能力吸収**  
   1分ごとに雑魚敵（プレイヤーより弱い）を出現。敵はマスク装着、マスクの色・形状で強さがわかる。倒すとマスクをドロップ。マスク回収で敵の能力の一部を吸収（**能力吸収力**パラメータで吸収量を決定）。
8b. **敵位置ガイド・索敵**  
   敵出現時、画面外も含め**敵の方向・距離をUIで3D的に表示**するガイドを実装。**索敵**パラメータで検知範囲（遠距離まで表示できるか）を決定。索敵・ガイド精度はアイテム・マスクで強化。
9. **ライバル・対戦・敗北・輪廻転生**  
   15分ごとにライバル出現、敵体力ゲージ・ヒット演出、エネルギー0以下で敗北→輪廻転生。
10. **旋回制御・グリップ（ドリフト／スリップ）**  
   進行方向ベクトルと向きの差をグリップで補間し、低グリップ時はドリフト感を出す。

---

## 9. パラメータ関連の補足

- **現在**: ランタイム状態 4、定数 7、アイテム関連 2。
- 攻撃・防御は「攻撃クールダウン」「防御クールダウン」で用語を統一。
- 戦闘・防御・生存時間・旋回制御・雑魚敵・マスク・能力吸収力・**索敵・敵位置ガイド**・ライバル・輪廻転生は未実装で、上記ステップ 6〜10 に整理済み。
- 索敵・敵位置ガイド・各種パラメータはアイテム取得・マスク回収で強化され、アイテム・マスクを集めることが有利になる設計。

### 9.1 数値・式メモ（調整用）

| 項目 | 案 | 備考 |
|------|-----|------|
| 与ダメージ | 攻撃力 × 係数 × (1〜1.5 クリティカル) | 敵防御力で軽減。係数は後で調整。 |
| 被ダメージ軽減 | 防御力に応じた軽減率（例: 0〜50%） | 回避力は別途「確率で0ダメージ」など。 |
| マスクドロップ条件 | 一撃でエネルギー25%以上減少 | 1回の攻撃で25%以上削れたら1枚ドロップ。 |
| 能力吸収量 | 敵の能力 × 能力吸収力（0〜1） | 装備・バフで能力吸収力を上げる。 |
| 成長選択の上昇量 | パラメータごとに+N or +X% | 運で選択肢数3〜5。上昇量はボーナスでやや多め。 |
| 雑魚敵体力 | 例: 最大30 | ライバルは100前後でプレイヤー同等。 |

---

## 10. 次のアクション（推奨）

- **ビジュアルは一旦完了**として、**企画に沿った実装は Phase 1 から進める**。
- **最初に手を付ける候補**  
  - **ステップ1**：クールダウン時間のパラメータ化（既に1.0秒などで実装済みなら定数化・ドキュメント化のみ）。  
  - **ステップ7**：生存時間・年齢のパラメータ化（経過時間の保持・表示）。5分／15分トリガーの前提になる。  
  - **ステップ2**：食べ物の種類と一時バフ（効果タイプ・持続時間・キュー消費）。  
- 上記の順で進めると、**成長選択ダイアログ（7b）**のトリガー（5分＋アイテム取得）と**UI数値表示（4）**がやりやすくなる。
