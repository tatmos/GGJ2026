# 3D 街中ラン 企画書

## 1. 概要

3D空間の街中を飛行し、アイテムを取得しながら生存時間を伸ばし、定期的に出現する敵・ライバルと対戦するゲーム。  
**マスク**は複数所持でき、敵を倒すとドロップし回収して能力を吸収できる。同種のマスクは合成され効果が上がる。多く持つほど有利だが、大きなダメージを受けるとマスクを落とす。敵もプレイヤーや雑魚を倒してマスクを奪い強くなる。  
エネルギー消費の加速・減速、回復クールダウン、成長ボーナス、装備・磁石・ストレージなどのパラメータ拡張を実装。敗北時は輪廻転生して再挑戦する。

---

## 2. 実装状況一覧

### ✅ 実装済み機能

| カテゴリ | 機能 | 詳細 |
|---------|------|------|
| 移動 | 基本飛行 | W/S加速減速、A/D旋回、Q/E上下 |
| 移動 | グリップ（ドリフト） | 旋回時に移動方向が遅れて追従 |
| 移動 | カメラ傾き | 旋回時のロール、上下移動時のピッチ |
| 移動 | 街境界 | バウンディングボックス外で自動旋回 |
| 移動 | ソフトロックオン | 近くの敵にカメラが自動追尾 |
| アイテム | 食べ物3種類 | エネルギー、速度Up、回復短縮 |
| アイテム | バフキュー | 取得順に消費、持続時間付き |
| アイテム | 装備16種類 | 各種効果、簡易3Dモデル |
| アイテム | 宝石12種類 | 誕生石ベース、ランダム効果 |
| アイテム | バッグ | 別枠無制限、装備スロット+2 |
| アイテム | 磁石効果 | 取得範囲拡大・アイテム吸引 |
| 敵 | 雑魚敵 | 30秒〜1分ごとに出現 |
| 敵 | ライバル | 15分ごとに出現、HP100 |
| 敵 | 自動戦闘 | 近距離で自動攻撃 |
| 敵 | 体力バー | 各敵の頭上に表示 |
| マスク | 敵ドロップ | 敵を倒すとマスクをドロップ |
| マスク | 回収・合成 | 同種マスクはレベルアップ |
| マスク | プレイヤードロップ | 大ダメージ（25%以上）で落とす |
| マスク | マスクセンサー | ドロップマスクへの誘導UI |
| 成長 | 成長選択 | 5分ごと、アイテム取得時に発動 |
| 成長 | パラメータ成長 | 攻撃/防御/回避/取得範囲/グリップ/吸収/索敵 |
| 敗北 | 敗北・輪廻転生 | エネルギー0で敗北、マスク一部引き継ぎ |
| UI | 生存時間表示 | 大型表示 + 次の成長選択までの残り時間 |
| UI | ステータスパネル | 各種数値を常時表示 |
| UI | 装備パネル | 装備・バッグの一覧 |
| UI | マスク一覧 | 所持マスクとレベル |
| UI | バフキュー | アクティブバフ + 待機キュー |
| UI | 敵ガイド | 索敵範囲内の敵の方向・距離 |
| UI | ボスパネル | ライバルのHP・マスク数 |
| UI | 戦闘ログ | 攻撃・被ダメージ・撃破・マスク入手 |
| UI | 境界警告 | 街の外に出ると警告表示 |

### ❌ 未実装・今後の拡張

| カテゴリ | 機能 | 優先度 |
|---------|------|--------|
| アイテム | 食べ物リスポーン | 中 |
| 敵 | 敵同士の戦闘 | 中 |
| 敵 | 敵がマスクを拾う | 中 |
| 演出 | SE・サウンド | 高 |
| 演出 | パーティクル・エフェクト | 中 |
| バランス | 数値チューニング | 高 |

---

## 3. 操作方法

| キー | 動作 |
|------|------|
| W | 加速（エネルギー消費） + 上昇 |
| S | 減速（エネルギー消費） + 下降 |
| A | 左旋回 |
| D | 右旋回 |
| Q | 上昇のみ |
| E | 下降のみ |

---

## 4. ゲームシステム

### 4.1 エネルギー

- 0〜100の範囲
- W/S操作で消費、静止中に回復
- 食べ物取得で即時回復（+25）
- 0になると敗北

### 4.2 食べ物・バフ

詳細: [docs/food-spec.md](docs/food-spec.md)

| typeId | 名前 | 色 | 効果 | 持続 | 出現率 |
|--------|------|----|------|------|--------|
| `energy` | エネルギー | 黄 | エネルギー +25 | — | 85% |
| `speedUp` | 速度Up | 緑 | 速度 ×1.2 | 30秒 | 10% |
| `recoveryCooldownShort` | 回復短縮 | 青 | 回復CD ×0.5 | 45秒 | 5% |

### 4.3 装備・宝石

詳細: [docs/equipment-spec.md](docs/equipment-spec.md)

- 装備スロット: 初期5枠（バッグで+2ずつ拡張）
- 宝石: 誕生石12種類
- 装備: 16種類（バッグ、磁石、靴、メガネ、防具、武器、時計、薬、翼、自転車、釣り具、帽子、タオル、旗、服、料理道具）
- 出現: OpenStreetMapのお店データに基づき配置

### 4.4 装備効果一覧

| 効果 | 適用先 | 装備例 |
|------|--------|--------|
| speed | 移動速度 | 靴、翼 |
| groundSpeed | 水平移動 | 自転車 |
| verticalSpeed | 上下移動 | 翼 |
| attack | 攻撃力 | 武器 |
| defense | 防御力 | 防具、帽子、服 |
| pickupRange | 取得範囲 | 磁石 |
| magnetism | アイテム吸引 | 磁石 |
| detection | 索敵範囲 | メガネ |
| buffDuration | バフ持続 | 時計 |
| recoveryCooldown | 回復CD短縮 | 薬 |
| energyRegen | 回復速度 | 薬 |
| foodBuffBoost | 食事効果強化 | 料理道具 |

### 4.5 マスク

| 系統 | 色 | 効果 |
|------|-----|------|
| 赤系 | #ff4444 | 攻撃力 |
| 青系 | #4444ff | 防御力 |
| 緑系 | #44ff44 | 速度 |
| 黄系 | #ffff44 | 取得範囲・吸引 |
| 紫系 | #ff44ff | 索敵・持続 |

- 同種マスクは合成でレベルアップ（Lv2=1.2倍、Lv3=1.3倍...）
- 大ダメージ（25%以上）でランダムに1つドロップ

---

## 5. 敵システム

### 5.1 雑魚敵

- 出現: 30秒後に最初、以降1分ごと
- HP: 30
- 行動: プレイヤーを追尾
- ドロップ: マスク1〜3個

### 5.2 ライバル

- 出現: 15分ごと
- HP: 100
- 行動: プレイヤーを追尾（通常の3倍の強さ）
- UI: ボスパネルにHP・マスク数表示
- 警告: 出現時に画面中央に警告表示

### 5.3 戦闘

- 自動攻撃: 近距離（範囲内）で自動発動
- ダメージ表示: 3Dの数値ポップアップ
- 戦闘ログ: 攻撃・被ダメージ・撃破をUI表示

---

## 6. 成長システム

### 6.1 成長選択ダイアログ

- トリガー: 5分ごとにフラグ → 食べ物取得時に発動
- 選択肢: 3〜5個（回避力が高いほど多い）
- ゲームポーズ: ダイアログ表示中は停止

### 6.2 成長パラメータ

| パラメータ | アイコン | 上昇値 |
|-----------|---------|--------|
| 攻撃力 | ⚔️ | +2 |
| 防御力 | 🛡️ | +1 |
| 回避力 | 💨 | +1 |
| 取得範囲 | 🧲 | +1 |
| グリップ | 🎯 | +0.2 |
| 吸収力 | ✨ | +0.1 |
| 索敵 | 👁️ | +2 |

---

## 7. 敗北・輪廻転生

### 7.1 敗北条件

- エネルギーが0になると敗北

### 7.2 輪廻転生

| リセットされるもの | 引き継がれるもの |
|-------------------|-----------------|
| パラメータ | マスク（転生回数分） |
| 装備・バッグ | 転生回数 |
| バフ | — |
| 生存時間 | — |
| カメラ位置 | — |

- 転生1回目: マスク1個引き継ぎ
- 転生2回目: マスク2個引き継ぎ...
- マスクはレベルが高い順に保持

---

## 8. UI一覧

| 位置 | UI | 内容 |
|------|-----|------|
| 上中央 | 生存時間 | 大型表示 + 次の成長選択まで |
| 右上 | デバッグパネル | FPS等 |
| 右 | ステータスパネル | 生存/転生/攻撃/防御/回避/取得範囲/グリップ/吸収/索敵 |
| 右 | 装備パネル | 装備リスト + バッグ |
| 右 | マスクパネル | 所持マスク一覧 |
| 右 | バフパネル | アクティブバフ + キュー |
| 右中央 | 敵ガイド | 索敵範囲内の敵の方向・距離 |
| 左中央 | マスクセンサー | ドロップマスクへの誘導 |
| 上中央 | ボスパネル | ライバルのHP・マスク数 |
| 下中央 | 戦闘ログ | 攻撃・被ダメージ等 |
| 上中央 | 境界警告 | 街の外に出ると表示 |
| 左下 | POS/ALT/SPEED | 座標・高度・速度 |
| 右下 | 方向メーター | コンパス |

---

## 9. 技術仕様

### 9.1 ファイル構成

```
js/
├── main.js        # メインループ・ゲーム状態
├── scene.js       # Three.jsシーン作成
├── city.js        # 街モデル・バウンディングボックス
├── player.js      # プレイヤー定数・境界チェック
├── food.js        # 食べ物スポーン・取得
├── equipment.js   # 装備スポーン・3Dモデル
├── inventory.js   # インベントリ管理・効果計算
├── buffs.js       # バフキュー・効果適用
├── enemy.js       # 敵AI・スポーン・ヘルスバー
├── combat.js      # 戦闘・ダメージ計算
├── mask.js        # マスクドロップ・回収・合成
├── ui.js          # UI更新関数
└── proximity.js   # 近接表示制御
```

### 9.2 データファイル

```
data/
├── transform.json       # 座標変換パラメータ
├── food_spawns.json     # 食べ物スポーン位置
└── equipment_spawns.json # 装備スポーン位置
```

### 9.3 スクリプト

```
scripts/
├── fetch_shops.py      # OSMからお店データ取得
├── convert_shops.py    # お店データをゲーム座標に変換
└── coord_transform.py  # 座標変換計算
```

---

## 10. 今後の開発予定

### 優先度: 高

1. **SE・サウンド追加** - 攻撃・取得・敗北等の効果音
2. **バランス調整** - 敵の強さ・マスク効果・成長量

### 優先度: 中

3. **食べ物リスポーン** - 時間経過で再出現
4. **敵同士の戦闘** - 雑魚vs雑魚、ライバルvs雑魚
5. **敵がマスクを拾う** - プレイヤーが落としたマスクを回収

### 優先度: 低

6. **ビジュアル改善** - パーティクル・エフェクト
7. **追加の食べ物タイプ** - 取得範囲Up、攻撃Up等
