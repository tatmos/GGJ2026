# 近接・市松模様のロジック整理

## もともとの「26m」の意味（変更前）

- **プレイヤーの最低高度が 26m**（`player.js` の `minHeight = 26`）だったため、
- 「**高さ 26m 以下**の部分は、近接時でも**半透明にせず市松模様だけ不透明**で表示する」というルールがありました。
- 意図: 「地面付近・低い建物」は常に不透明にして、見通しを保つ。

## いまの「カメラより下」の意味（変更後）

- 26m 固定をやめ、「**カメラの Y 座標より下**の部分は、近接時でも**市松・不透明**」に変更しました。
- 判定は次の 2 箇所で行われています。

### 1. シェーダー（ピクセル単位）

- 条件: `vWorldPosition.y <= u_cameraPosition.y`
- **カメラより下のピクセル** → 常に市松色・`alpha = 1.0`（距離フェード・半透明なし）
- **カメラより上のピクセル** → 距離 15〜30m で市松→グレーにフェード、透明度もフェード

### 2. メッシュ単位のマテリアル切り替え（JavaScript）

- `isMeshBelowCamera(mesh, camera)`  
  → メッシュ全体の AABB の **max.y <= camera.position.y** なら `true`
- `true` のメッシュ → **不透明マテリアル**（`proximityMatWorldOpaque` / `midMatWorldOpaque`）を使用  
  → ワイヤーフレームなし、`depthWrite: true`
- `false` のメッシュ → **半透明マテリアル**（`proximityMatWorld` / `midMatWorld`）を使用  
  → 近接でワイヤーフレーム、`depthWrite: false`

## 「もともとの 26m 市松」が影響を受ける理由

- **変更前**: 「26m 以下」という**絶対的な高さ**で不透明だった。
- **変更後**: 「カメラより下」という**カメラの高さに依存する**条件で不透明になっている。

そのため次のような違いが出ます。

| 状況 | 26m 固定のとき | カメラ基準のいま |
|------|----------------|------------------|
| カメラが 80m 付近 | 26m 以下だけ不透明（26〜80m は距離フェード・半透明の対象） | **80m より下はすべて不透明**（26m 以上も含む） |
| カメラが 30m 付近 | 26m 以下だけ不透明 | **30m より下はすべて不透明** |
| カメラが 26m 付近 | 26m 以下だけ不透明 | **26m より下はすべて不透明**（挙動はほぼ同じ） |

- カメラが**高い位置**（例: 80m）にいるとき、**26m〜80m の建物**も「カメラより下」になるため、  
  以前は半透明・フェードの対象だった部分まで、いまは**すべて市松・不透明**で描画されます。
- これが「もともとの 26m の市松模様のルールが、今の変更の影響を受けている」ように見える理由です。

## まとめ

- **現在の仕様**: 「カメラより下 ＝ 常に市松・不透明」が**唯一の「不透明優先」ルール**になっており、  
  過去にあった「26m という絶対的な高さ」の判定はコード上には残っていません。
- 「26m 以下だけ不透明にしたい（プレイヤー最低高度の意味で）」と「カメラより下は不透明にしたい」の**両方**を満たしたい場合は、  
  例: 「**y <= 26 または y <= カメラの Y**」のように、26m とカメラの両方を条件に含める実装に変更する必要があります。
