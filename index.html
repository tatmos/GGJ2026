<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D 街中ラン</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- 成長選択ダイアログ -->
  <div id="growthDialog" class="growth-dialog hidden">
    <div class="growth-dialog-content">
      <div class="growth-dialog-title">成長選択</div>
      <div class="growth-dialog-subtitle">パラメータを1つ選んで強化しよう</div>
      <div class="growth-dialog-options" id="growthOptions"></div>
    </div>
  </div>
  <!-- 敗北・輪廻転生ダイアログ -->
  <div id="defeatDialog" class="defeat-dialog hidden">
    <div class="defeat-dialog-content">
      <div class="defeat-dialog-title">敗北...</div>
      <div class="defeat-dialog-stats">
        <div>生存時間: <span id="defeatSurvivalTime">0:00</span></div>
        <div>転生回数: <span id="defeatReincarnation">0</span></div>
        <div>引き継ぐマスク: <span id="defeatMaskCount">0</span> 個</div>
      </div>
      <div class="defeat-dialog-subtitle">輪廻転生して再び挑戦しよう</div>
      <button class="defeat-dialog-button" id="reincarnateButton">転生する</button>
    </div>
  </div>
  <!-- ライバル出現警告 -->
  <div id="rivalWarning" class="rival-warning hidden">
    <div class="rival-warning-text">⚠ ライバル出現 ⚠</div>
  </div>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="text">Loading... / 読み込み中</div>
    <div class="progress-wrap">
      <div class="progress-fill" id="loadingProgressFill"></div>
    </div>
    <div class="progress-pct" id="loadingProgressPct">0%</div>
  </div>
  <div id="ui">
    <div class="energy-wrap">
      <div class="energy-label">エネルギー</div>
      <div class="energy-bar-bg">
        <div class="energy-bar" id="energyBar"></div>
      </div>
    </div>
    <div class="status-panel" aria-hidden="true">
      <div class="status-row"><span>生存</span><span id="statusSurvival">0:00</span></div>
      <div class="status-row"><span>転生</span><span id="statusReincarnation">0</span></div>
      <div class="status-row"><span>攻撃</span><span id="statusAttack">10</span></div>
      <div class="status-row"><span>防御</span><span id="statusDefense">5</span></div>
      <div class="status-row"><span>回避</span><span id="statusEvasion">5</span></div>
      <div class="status-row"><span>取得範囲</span><span id="statusPickupRange">5</span></div>
      <div class="status-row"><span>グリップ</span><span id="statusGrip">1</span></div>
      <div class="status-row"><span>吸収力</span><span id="statusAbsorb">1</span></div>
      <div class="status-row"><span>索敵</span><span id="statusSearch">5</span></div>
    </div>
    <div class="equipment-panel" id="equipmentPanel" aria-hidden="true">
      <div class="equipment-header">装備 (0/5)</div>
      <div class="equipment-list"></div>
    </div>
    <div class="mask-panel" aria-hidden="true">
      <div class="mask-header">マスク: <span id="maskCount">0</span> 個</div>
      <div class="mask-slots" id="maskSlots"></div>
    </div>
    <div class="buff-panel" aria-hidden="true">
      <div class="buff-header">バフ・キュー</div>
      <div class="buff-active" id="buffActive"></div>
      <div class="buff-queue" id="buffQueue"></div>
    </div>
  </div>
  <div class="enemy-guide" id="enemyGuide" aria-hidden="true">
    <div class="enemy-guide-label">索敵</div>
    <div class="enemy-guide-list" id="enemyGuideList"></div>
  </div>
  <div class="mask-sensor" id="maskSensor" aria-hidden="true">
    <div class="mask-sensor-label">🎭 マスク検知</div>
    <div class="mask-sensor-list" id="maskSensorList"></div>
  </div>
  <div class="boss-panel" id="bossPanel" aria-hidden="true">
    <div class="boss-label">ライバル</div>
    <div class="boss-hp"><span id="bossHp">0</span>/<span id="bossHpMax">100</span></div>
    <div class="boss-masks">マスク <span id="bossMaskCount">0</span></div>
  </div>
  <div class="combat-log" id="combatLog"></div>
  <div class="survival-display" id="survivalDisplay">
    <div class="survival-time" id="survivalTime">0:00</div>
    <div class="survival-milestone" id="survivalMilestone">次の成長選択まで 5:00</div>
  </div>
  <div class="boundary-warning" id="boundaryWarning">⚠ 街の外に出ています ⚠</div>
  <!-- 円形レーダー（ミニマップ付き） -->
  <div class="radar" id="radar" aria-hidden="true">
    <canvas class="radar-minimap" id="radarMinimap" width="150" height="150"></canvas>
    <div class="radar-bg">
      <div class="radar-ring radar-ring-outer"></div>
      <div class="radar-ring radar-ring-mid"></div>
      <div class="radar-ring radar-ring-inner"></div>
      <div class="radar-cross"></div>
      <div class="radar-north" id="radarNorth"></div>
    </div>
    <div class="radar-player"></div>
    <div class="radar-dots" id="radarDots"></div>
    <div class="radar-range" id="radarRange">50m</div>
  </div>
  <div class="pos-meter" aria-hidden="true">
    <div class="label">POS (XYZ)</div>
    <div class="row"><span>X: <span id="posX">0</span></span><span>Y: <span id="posY">0</span></span><span>Z: <span id="posZ">0</span></span></div>
  </div>
  <div class="alt-meter" aria-hidden="true">
    <span class="label">ALT</span>
    <div>
      <span class="value" id="altValue">0</span><span class="unit">m</span>
    </div>
    <div class="gauge">
      <div class="gauge-fill" id="altGauge"></div>
    </div>
  </div>
  <div class="speed-meter" aria-hidden="true">
    <span class="label">SPEED</span>
    <div>
      <span class="value" id="speedValue">0</span><span class="unit">m/s</span>
    </div>
    <div class="gauge">
      <div class="gauge-fill" id="speedGauge"></div>
    </div>
  </div>
  <div class="direction-meter" aria-hidden="true">
    <div class="labels">
      <span class="n">N</span><span class="e">E</span><span class="s">S</span><span class="w">W</span>
    </div>
    <div class="needle" id="directionNeedle"></div>
  </div>
  <div class="debug-panel">
    <div class="debug-row">
      <input type="checkbox" id="debugCheckbox" />
      <label for="debugCheckbox">Debug</label>
      <span id="debugFps" class="debug-fps" aria-hidden="true"></span>
    </div>
    <div id="debugMenu" class="debug-menu" aria-hidden="true">
      <label><input type="checkbox" id="debugProximityCheckbox" checked /> 近接半透明</label>
      <label><input type="checkbox" id="debugCheckerCheckbox" checked /> 近接時の市松模様（オフで負荷軽減）</label>
      <span id="debugCheckerState" class="debug-state" aria-hidden="true"></span>
      <label><input type="checkbox" id="debugWorldCheckerCheckbox" checked /> 市松をワールド座標で表示（UVが無いモデル用）</label>
      <hr style="margin:8px 0;border-color:#555"/>
      <div style="margin:8px 0;">
        <span style="font-size:11px;color:#aaa;">時間倍速:</span>
        <select id="timeScaleSelect" style="font-size:11px;margin-left:4px;">
          <option value="1">1x（通常）</option>
          <option value="2">2x</option>
          <option value="5">5x</option>
          <option value="10">10x</option>
          <option value="30" selected>30x</option>
          <option value="60">60x（1分=1秒）</option>
        </select>
        <span id="timeScaleInfo" style="font-size:10px;color:#88ff88;margin-left:8px;"></span>
      </div>
      <hr style="margin:8px 0;border-color:#555"/>
      <label><input type="checkbox" id="birdEyeCheckbox" /> 俯瞰カメラモード（マッピング用）</label>
      <div id="birdEyeControls" style="display:none;margin-top:8px;">
        <div style="font-size:11px;color:#aaa;margin-bottom:4px;">クリックで対応点を登録。矢印キーで移動、+/-でズーム</div>
        <div style="margin-bottom:4px;">
          <span style="font-size:11px;">緯度:</span>
          <input type="text" id="refPointLat" placeholder="35.6963" style="width:80px;font-size:11px;"/>
          <span style="font-size:11px;margin-left:4px;">経度:</span>
          <input type="text" id="refPointLng" placeholder="139.7832" style="width:80px;font-size:11px;"/>
        </div>
        <div style="margin-bottom:4px;">
          <span style="font-size:11px;">名前:</span>
          <input type="text" id="refPointName" placeholder="浅草橋駅" style="width:120px;font-size:11px;"/>
        </div>
        <button id="addRefPointBtn" style="font-size:11px;padding:2px 8px;">対応点を登録</button>
        <button id="exportRefPointsBtn" style="font-size:11px;padding:2px 8px;margin-left:4px;">JSON出力</button>
        <div id="refPointList" style="margin-top:8px;font-size:11px;max-height:120px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>
  
  <!-- クレジットボタン -->
  <button id="creditsBtn" class="credits-btn">Credits</button>
  
  <!-- クレジットダイアログ -->
  <dialog id="creditsDialog" class="credits-dialog">
    <h2>Credits</h2>
    <div class="credits-content">
      <section>
        <h3>Development</h3>
        <p><strong>tatmos</strong></p>
      </section>
      <section>
        <h3>Development Environment</h3>
        <ul>
          <li>Cursor (auto, Opus 4.5)</li>
          <li>Blender</li>
          <li>Python</li>
          <li>PLATEAU GIS Converter</li>
        </ul>
      </section>
      <section>
        <h3>Map Data</h3>
        <p>© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors</p>
      </section>
      <section>
        <h3>3D City Model</h3>
        <p>PLATEAU by MLIT Japan (国土交通省)</p>
        <p class="license-note">Licensed under CC BY 4.0</p>
      </section>
      <section>
        <h3>Game Engine</h3>
        <p><a href="https://threejs.org/" target="_blank" rel="noopener">Three.js</a> - MIT License</p>
      </section>
      <section class="ggj-section">
        <h3>Global Game Jam 2026</h3>
        <p>Theme: "BUBBLE"</p>
      </section>
    </div>
    <button id="creditsCloseBtn" class="credits-close-btn">Close</button>
  </dialog>
  
  <div id="birdEyeCrosshair" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:100;">
    <div style="width:20px;height:2px;background:#ff0;position:absolute;left:-10px;top:-1px;"></div>
    <div style="width:2px;height:20px;background:#ff0;position:absolute;left:-1px;top:-10px;"></div>
  </div>
  <div id="birdEyeCoord" style="display:none;position:fixed;top:50%;left:calc(50% + 20px);transform:translateY(-50%);color:#ff0;font-size:14px;font-family:monospace;pointer-events:none;z-index:100;text-shadow:1px 1px 2px #000;"></div>
  <p class="hint">W: 加速+上昇　S: 減速+下降　A/D: 旋回　Q/E: 上下　何もしないと約1秒で自動下降（26mまで）　食べ物で回復</p>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <!-- 敵ラベルコンテナ -->
  <div id="enemyLabels" class="enemy-labels-container"></div>
  
  <!-- モバイル用タッチコントロール -->
  <div id="touchControls" class="touch-controls">
    <!-- 左側: 旋回用ジョイスティック -->
    <div class="touch-joystick touch-joystick-left" id="joystickLeft">
      <div class="joystick-base">
        <div class="joystick-stick" id="joystickLeftStick"></div>
      </div>
      <div class="joystick-label">旋回</div>
    </div>
    
    <!-- 右側: 速度用ジョイスティック -->
    <div class="touch-joystick touch-joystick-right" id="joystickRight">
      <div class="joystick-base">
        <div class="joystick-stick" id="joystickRightStick"></div>
      </div>
      <div class="joystick-label">速度</div>
    </div>
  </div>
  
  <script type="module" src="js/main.js"></script>
</body>
</html>
